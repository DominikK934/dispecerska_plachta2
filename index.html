<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Dispečerská plachta – inline úpravy</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/isBetween.js"></script>
  <script src="https://unpkg.com/dayjs/plugin/isoWeek.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; vertical-align: top; }
    th { background: #eee; }
    input, select, button { margin: 2px; padding: 4px; }
    .week-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    // Aktivace Day.js pluginů
    dayjs.extend(window.dayjs_plugin_isoWeek);
    dayjs.extend(window.dayjs_plugin_isBetween);

    const { useState } = React;
    const daysOfWeek = ["Pondělí","Úterý","Středa","Čtvrtek","Pátek","Sobota","Neděle"];

    function App() {
      const [weekStart, setWeekStart] = useState(dayjs().startOf("week").add(1,"day"));
      const [vehicles, setVehicles] = useState([{id:1,spz:"",trailer:"",driver:"",note:""}]);
      const [shipments, setShipments] = useState([]);

      const weekDates = Array.from({length:7},(_,i)=>weekStart.add(i,"day"));
      const addVehicle = ()=> setVehicles([...vehicles,{id:Date.now(),spz:"",trailer:"",driver:"",note:""}]);
      const updateVehicle = (id,field,val)=> setVehicles(vehicles.map(v=>v.id===id?{...v,[field]:val}:v));

      const addShipment = () => {
        const defaultVehicle = vehicles[0]?.id;
        setShipments([...shipments,{
          id:Date.now(), vehicleId:defaultVehicle,
          company:"",from:"",to:"",
          weight:"",price:"",distance:"",transferKm:"",
          loadTime: dayjs().format("YYYY-MM-DDT08:00"),
          unloadTime: dayjs().add(1,"day").format("YYYY-MM-DDT17:00")
        }]);
      };
      const updateShipment = (id,field,val)=> setShipments(shipments.map(s=>s.id===id?{...s,[field]:val}:s));

      const filterShipments = (vid,day)=> shipments.filter(s=>{
        const l=dayjs(s.loadTime), u=dayjs(s.unloadTime);
        return s.vehicleId===vid && day.isBetween(l.startOf("day"),u.endOf("day"),null,"[]");
      });

      const calcWeeklyStats = vid=>{
        const start=weekStart.startOf("day"), end=weekStart.add(6,"day").endOf("day");
        const vship=shipments.filter(s=>
          s.vehicleId===vid &&
          (dayjs(s.loadTime).isBetween(start,end,null,"[]")||dayjs(s.unloadTime).isBetween(start,end,null,"[]"))
        );
        const km=vship.reduce((a,s)=>a+(+s.distance||0)+(+s.transferKm||0),0);
        const czk=vship.reduce((a,s)=>a+(+s.price*(+s.weight/1000)),0);
        return km? (czk/km).toFixed(2):"0";
      };

      return (
        <div>
          <h2>Dispečerská plachta – inline úpravy</h2>
          <div className="week-header">
            <label>Začátek týdne:</label>
            <input type="date" value={weekStart.format("YYYY-MM-DD")}
                   onChange={e=>setWeekStart(dayjs(e.target.value))} />
            <button onClick={()=>setWeekStart(weekStart.subtract(7,"day"))}>← Předchozí</button>
            <button onClick={()=>setWeekStart(weekStart.add(7,"day"))}>Další →</button>
          </div>
          <button onClick={addVehicle}>Přidat vozidlo</button>
          <button onClick={addShipment}>Přidat přepravu</button>
          <table>
            <thead>
              <tr>
                <th>Vozidlo / Den</th>
                {weekDates.map((d,i)=><th key={i}>
                  {daysOfWeek[i]}<br/>{d.format("DD.MM.YYYY")}
                </th>)}
              </tr>
            </thead>
            <tbody>
              {vehicles.map(v=>(
                <tr key={v.id}>
                  <td>
                    <input placeholder="SPZ" value={v.spz}
                           onChange={e=>updateVehicle(v.id,"spz",e.target.value)}/><br/>
                    <input placeholder="Návěs" value={v.trailer}
                           onChange={e=>updateVehicle(v.id,"trailer",e.target.value)}/><br/>
                    <input placeholder="Řidič" value={v.driver}
                           onChange={e=>updateVehicle(v.id,"driver",e.target.value)}/><br/>
                    <input placeholder="Poznámka" value={v.note}
                           onChange={e=>updateVehicle(v.id,"note",e.target.value)}/><br/>
                    <b>Výsledek: {calcWeeklyStats(v.id)} CZK/km</b>
                  </td>
                  {weekDates.map((day,i)=>(
                    <td key={i}>
                      {filterShipments(v.id,day).map(s=>(
                        <div key={s.id} style={{marginBottom:4,padding:4,border:"1px solid #ddd"}}>
                          <input value={s.company} placeholder="Firma"
                                 onChange={e=>updateShipment(s.id,"company",e.target.value)}/><br/>
                          <input value={s.from} placeholder="Odkud"
                                 onChange={e=>updateShipment(s.id,"from",e.target.value)}/> →
                          <input value={s.to} placeholder="Kam"
                                 onChange={e=>updateShipment(s.id,"to",e.target.value)}/><br/>
                          <input type="datetime-local" value={s.loadTime}
                                 onChange={e=>updateShipment(s.id,"loadTime",e.target.value)}/> →
                          <input type="datetime-local" value={s.unloadTime}
                                 onChange={e=>updateShipment(s.id,"unloadTime",e.target.value)}/><br/>
                          <input type="number" value={s.weight} placeholder="Váha"
                                 onChange={e=>updateShipment(s.id,"weight",e.target.value)}/>kg,
                          <input type="number" value={s.distance} placeholder="Km"
                                 onChange={e=>updateShipment(s.id,"distance",e.target.value)}/>km+
                          <input type="number" value={s.transferKm} placeholder="Přejezd"
                                 onChange={e=>updateShipment(s.id,"transferKm",e.target.value)}/>km<br/>
                          <input type="number" value={s.price} placeholder="Cena CZK/t"
                                 onChange={e=>updateShipment(s.id,"price",e.target.value)}/>=
                          {(s.price*s.weight/1000).toFixed(2)} CZK
                        </div>
                      ))}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
