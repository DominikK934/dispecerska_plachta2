<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Dispečerská plachta – inline úpravy (ESM)</title>
  <style>
    body { font-family:sans-serif; padding:1rem }
    table { width:100%; border-collapse:collapse; margin-top:1rem }
    th,td { border:1px solid #ccc; padding:8px; vertical-align:top }
    th { background:#eee }
    input,select,button { margin:2px; padding:4px }
    .week-header { display:flex; align-items:center; gap:10px; margin-bottom:10px }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="module">
    import React, { useState } from 'https://esm.sh/react@18';
    import ReactDOM from 'https://esm.sh/react-dom@18';
    import dayjs from 'https://esm.sh/dayjs';
    import isoWeek from 'https://esm.sh/dayjs/plugin/isoWeek';
    import isBetween from 'https://esm.sh/dayjs/plugin/isBetween';

    dayjs.extend(isoWeek);
    dayjs.extend(isBetween);

    const daysOfWeek = ["Pondělí","Úterý","Středa","Čtvrtek","Pátek","Sobota","Neděle"];

    function App() {
      const [weekStart, setWeekStart] = useState(dayjs().startOf('week').add(1,'day'));
      const [vehicles, setVehicles] = useState([{ id:1, spz:'', trailer:'', driver:'', note:'' }]);
      const [shipments, setShipments] = useState([]);

      const weekDates = Array(7).fill(0).map((_,i)=> weekStart.add(i,'day'));

      const addVehicle = () =>
        setVehicles(vs=>[...vs,{ id:Date.now(), spz:'', trailer:'', driver:'', note:'' }]);

      const updateVehicle = (id,field,val) =>
        setVehicles(vs=>vs.map(v=>v.id===id?{...v,[field]:val}:v));

      const addShipment = () => {
        const vid = vehicles[0]?.id;
        setShipments(s=>[...s,{
          id:Date.now(), vehicleId:vid,
          company:'', from:'', to:'',
          weight:'', price:'', distance:'', transferKm:'',
          loadTime: dayjs().format('YYYY-MM-DDT08:00'),
          unloadTime: dayjs().add(1,'day').format('YYYY-MM-DDT17:00')
        }]);
      };

      const updateShipment = (id,field,val) =>
        setShipments(s=>s.map(x=>x.id===id?{...x,[field]:val}:x));

      const filterShipments = (vid,day) =>
        shipments.filter(s=>{
          const L=dayjs(s.loadTime), U=dayjs(s.unloadTime);
          return s.vehicleId===vid && day.isBetween(L.startOf('day'), U.endOf('day'), null, '[]');
        });

      const calcWeeklyStats = vid => {
        const start=weekStart.startOf('day'), end=weekStart.add(6,'day').endOf('day');
        const vship = shipments.filter(s=>
          s.vehicleId===vid && (
            dayjs(s.loadTime).isBetween(start,end,null,'[]') ||
            dayjs(s.unloadTime).isBetween(start,end,null,'[]')
          )
        );
        const km = vship.reduce((a,s)=>a + (+s.distance||0) + (+s.transferKm||0), 0);
        const czk= vship.reduce((a,s)=>a + (+s.price * (+s.weight/1000)), 0);
        return km ? (czk/km).toFixed(2) : '0';
      };

      return (
        <div>
          <h2>Dispečerská plachta</h2>
          <div className="week-header">
            <label>Začátek týdne:</label>
            <input type="date"
                   value={weekStart.format('YYYY-MM-DD')}
                   onChange={e=>setWeekStart(dayjs(e.target.value))} />
            <button onClick={()=>setWeekStart(ws=>ws.subtract(7,'day'))}>← Předchozí</button>
            <button onClick={()=>setWeekStart(ws=>ws.add(7,'day'))}>Další →</button>
          </div>
          <button onClick={addVehicle}>Přidat vozidlo</button>
          <button onClick={addShipment}>Přidat přepravu</button>
          <table>
            <thead>
              <tr>
                <th>Vozidlo / Den</th>
                {weekDates.map((d,i)=>(
                  <th key={i}>{daysOfWeek[i]}<br/>{d.format('DD.MM.YYYY')}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {vehicles.map(v=>(
                <tr key={v.id}>
                  <td>
                    <input placeholder="SPZ"    value={v.spz}     onChange={e=>updateVehicle(v.id,'spz',e.target.value)} /><br/>
                    <input placeholder="Návěs" value={v.trailer} onChange={e=>updateVehicle(v.id,'trailer',e.target.value)} /><br/>
                    <input placeholder="Řidič"  value={v.driver}  onChange={e=>updateVehicle(v.id,'driver',e.target.value)} /><br/>
                    <input placeholder="Poznámka" value={v.note} onChange={e=>updateVehicle(v.id,'note',e.target.value)} /><br/>
                    <b>Výsledek: {calcWeeklyStats(v.id)} CZK/km</b>
                  </td>
                  {weekDates.map((day,i)=>(
                    <td key={i}>
                      {filterShipments(v.id,day).map(s=>(
                        <div key={s.id} style={{border:'1px solid #ddd',margin:'4px 0',padding:'4px'}}>
                          <input value={s.company}  placeholder="Firma"
                                 onChange={e=>updateShipment(s.id,'company',e.target.value)} /><br/>
                          <input value={s.from}     placeholder="Odkud"
                                 onChange={e=>updateShipment(s.id,'from',e.target.value)} /> → 
                          <input value={s.to}       placeholder="Kam"
                                 onChange={e=>updateShipment(s.id,'to',e.target.value)} /><br/>
                          <input type="datetime-local" value={s.loadTime}
                                 onChange={e=>updateShipment(s.id,'loadTime',e.target.value)} /> →
                          <input type="datetime-local" value={s.unloadTime}
                                 onChange={e=>updateShipment(s.id,'unloadTime',e.target.value)} /><br/>
                          <input type="number" value={s.weight}     placeholder="Váha (kg)"
                                 onChange={e=>updateShipment(s.id,'weight',e.target.value)} />kg, 
                          <input type="number" value={s.distance}   placeholder="Km"
                                 onChange={e=>updateShipment(s.id,'distance',e.target.value)} />km + 
                          <input type="number" value={s.transferKm} placeholder="Přejezd km"
                                 onChange={e=>updateShipment(s.id,'transferKm',e.target.value)} />km<br/>
                          <input type="number" value={s.price}      placeholder="Cena CZK/t"
                                 onChange={e=>updateShipment(s.id,'price',e.target.value)} /> = 
                          {(s.price * s.weight / 1000).toFixed(2)} CZK
                        </div>
                      ))}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
